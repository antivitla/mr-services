<link rel="import" href="../vendors/maquette.html">
<!-- <link rel="import" href="vendors/firebase.html"> -->
<!-- <link rel="import" href="vendors/freezer.html"> -->

<!-- <link rel="import" href="events/events.html"> -->
<!-- <link rel="import" href="storage/storage.html"> -->

<!-- <link rel="import" href="models/content.html">
<link rel="import" href="models/note.html">
<link rel="import" href="models/workspace.html"> -->

<!-- <link rel="import" href="views.html"> -->
<link rel="import" href="noteExpandable.html">
<link rel="import" href="button.html">

<link rel="stylesheet" href="../assets/desk.css">
<script src="https://use.fontawesome.com/f87b3e3109.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<desk></desk>


<script>

  //
  // Events
  //

  // events.Action.subscribe(function (action) {
  //   switch(action.type) {

  //     // Things

  //     case events.Keys.NOTE_EDIT:
  //       // effect
  //       storageEffectSave(workspace.key + "/blur/" + workspace.focus + "/content", action.payload);
  //       // model
  //       events.Intent.onNext(function (state) {
  //         return state
  //           .set("blur",
  //             state.blur.set(state.focus,
  //               state.blur[state.focus].set("content", action.payload)));
  //       });
  //       break;

  //     // User

  //     case events.Keys.NEW_CONTENT:
  //       // effect
  //       var content = {content: ""};
  //       content.key = storageEffectNewContent(workspace.key, content);
  //       // model
  //       events.Intent.onNext(function (state) {
  //         if (!state.blur[state.focus].content) {
  //           console.warn("current content is empty and you want new. Possibly storage memory leak.");
  //         }
  //         return state
  //           .set("focus", content.key)
  //           .set("blur",
  //             state.blur.set(content.key, content));
  //       });
  //       break;

  //     case events.Keys.PREV_CONTENT:
  //       // effect
  //       var contentKeys = Object.keys(workspace.blur);
  //       contentKeys.splice(contentKeys.indexOf(workspace.focus), 1);
  //       var randomContentKey = contentKeys[parseInt(Math.random() * contentKeys.length)];
  //       storageEffectSave(workspace.key + "/focus", randomContentKey);
  //       // model
  //       events.Intent.onNext(function (state) {
  //         return state.set("focus", randomContentKey);
  //       });
  //       break;

  //     // System

  //     case events.Keys.WORKSPACE_LOAD:
  //       if (!action.payload) {
  //         // effect
  //         events.Action.onNext({
  //           type: events.Keys.NEW_CONTENT
  //         });
  //       } else {
  //         if (!action.payload.blur[action.payload.focus]) {
  //           // effect
  //           console.warn("focus have non-existing content. Making new");
  //           var content = {content: ""};
  //           content.key = storageEffectNewContent(workspace.key, content);
  //           var blur = Object.assign({}, action.payload.blur);
  //           blur[content.key] = content;
  //           // model
  //           events.Intent.onNext(function (state) {
  //             return state
  //               .set("focus", content.key)
  //               .set("blur", blur);
  //           })
  //         } else {
  //           // model
  //           events.Intent.onNext(function (state) {
  //             return state
  //               .set("focus", action.payload.focus)
  //               .set("blur", action.payload.blur);
  //           });
  //         }
  //       }
  //       break;
  //   }
  // });

  // //
  // // Model
  // //

  // var workspace = {
  //   focus: "initial",
  //   blur: {
  //     "initial": {content: "Если вы видите это до сих пор, значит случилось что-то не то."}
  //   },
  //   key: "/workspace"
  // };

  // events.Model.subscribe(function (model) {
  //   workspace = model.toJS();
  // });

  // setTimeout(function () {
  //   events.bootstrap({
  //     state: (new Freezer(workspace)).get()
  //   });
  // }, 10);

  // //
  // // Storage effects
  // //

  // storage.focus.load(workspace.key, events.Keys.WORKSPACE_LOAD);

  // function storageEffectNewContent (workspacePath, newContent) {
  //   var key = storage.focus.add(workspacePath + "/blur", newContent);
  //   storage.focus.save(workspacePath + "/focus", key);
  //   return key;
  // }

  // function storageEffectSave(path, data) {
  //   storage.focus.save(path, data);
  // }

  // document.addEventListener("DOMContentLoaded", function () {
  //   views.bootstrap({
  //     dom: document.querySelector("desk"),
  //     renderMaquette: function () {
  //       return vendors.maquette.h("focus",
  //         [
  //           vendors.maquette.h("actions", [
  //             (Object.keys(workspace.blur).length > 1 ? uiPrevContent.renderMaquette() : ""),
  //             (workspace.blur[workspace.focus].content ? uiNewContent.renderMaquette() : ""),
  //           ]),
  //           uiContent.renderMaquette(),
  //         ]);
  //     }
  //   });
  // });

  views.workspace = function (options) {

    // Model

    var workspace = {
      context: "initialcontextid",
      focus: "initialcontentid",
      blur: {
        "initialcontentid": {content: "Начальный контент пространства. Меня не дожно быть видно"},
        "initialcontextid": {content: "Контекст"},
      },
      key: "/workspace/blur/initialkey",
      content: function () { return "Workspace content"; },
      type: "workspace",
    };

    events.Model.subscribe(function (model) {
      workspace = options.getModel(model).toJS();
    });

    // View

    var uiContent = views.noteExpandable({
      placeholder: "Пиши - не пиши, всё ложь...",
      rotate: (Math.random() - 0.5)*1.625,
      getModel: function (state) {
        return state.blur[options.getModel(state).focus].content;
      },
    });

    var uiNewContent = views.button({
      onclick: function (event) {
        events.Action.onNext({
          type: events.Keys.NEW_CONTENT,
          payload: {content: ""}
        });
      },
      selector: "a.new-content",
    });

    var uiPrevContent = views.button({
      onclick: function (event) {
        events.Action.onNext({
          type: events.Keys.PREV_CONTENT
        });
      },
      selector: "a.prev-content",
    });

    return {
      renderMaquette: function () {
        return vendors.maquette.h("workspace",
          [
            vendors.maquette.h("header",
              [
                (workspace.content ?
                  vendors.maquette.h("context", [workspace.blur[workspace.context].content]) :
                  ""),
                (Object.keys(workspace.blur).length > 1 ?
                  uiPrevContent.renderMaquette() :
                  ""),
                (workspace.blur[workspace.focus].content ?
                  uiNewContent.renderMaquette() :
                  ""),
              ]),
            uiContent.renderMaquette(),
            // vendors.maquette.h("footer",[""]),
          ]);
      }
    }
  };

</script>

<style>
  workspace {
    display: block;
  }

  workspace context {
    font-size: medium;
    display: block;
  }

  workspace note {
    margin: 1rem auto;
    box-shadow: 0px 1px 5px 0px rgba(0,0,0,0.1);
    border-radius: 0.25em;
    position: relative;
    left: 0;
    transition: left 0.3s;
  }

  workspace header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    min-height: 3rem;
  }

  workspace footer {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    position: absolute;
    left: 1rem;
    bottom: 1rem;
  }

  workspace header context {
    line-height: 1rem;
    padding: 1rem 0.5rem;
    opacity: 0.3;
    font-size: medium;
  }

  workspace .new-content,
  workspace .prev-content {
    display: inline-block;
    color: rgba(0,0,0,0.2);
    /*background-color: red;*/
    padding: 0 1rem;
    height: 3rem;
    line-height: 3rem;
    font-size: medium;
    cursor: pointer;
  }

  workspace .new-content:first-child:last-child {
    margin-right: 0;
    margin-left: auto;
  }

  workspace .new-content:after {
    content: "+";
    font-size: xx-large;
  }

  workspace .prev-content:after {
    content: "⋯"; /* … */
    font-size: xx-large;
    position: relative;
    top: -2px;
  }
</style>